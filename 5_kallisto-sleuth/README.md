# kallisto、sleuthを用いた処理  
- （20210210追記）sleuthでkallistoの出力結果を読み込む際にエラーが生じるようです。  
  - ```"sleuth" hdf5. file accessibilty. unable to open file```  
- kallistoを動かす時点で警告が出ていましたので、kallisto側の問題かと思われます。  
  - ```Warning: kallisto was not compiled with HDF5 support so no bootstrapping```  
  - ```# will be performed. Run quant with --plaintext option or recompile with```  
  - ```# HDF5 support to obtain bootstrap estimates.```
- ネットでは解決策が見つけられなかったので、難しそうです。ひとまずcondaで独立した環境を用意し、その中で処理をすすめるのがよいかもしれません。[解決案](https://shallowbioinfomatics.blogspot.com/2021/02/sleuth-hdf5-file-accessibilty-unable-to.html)  
## kallisto  
- kallisto用のインデックス作成（下記の「--index」部分を「-i」にしないと動かない場合があるので、エラーが出た場合はお試しください）  
  - ```kallisto index --index=~/Documents/expression/ref/kallisto.idx ~/Documents/expression/ref/Homo_sapiens.GRCh38.cdna.all.fa.gz```  
  - 完了すると~/Documents/expression/ref ディレクトリ内に kallisto.idx というインデックスファイルが作成される。  
- kallisto [公式ページ](https://github.com/pachterlab/kallisto-transcriptome-indices/releases)からインデックスファイルをダウンロードした場合は下記のコマンドで解凍  
  - ```gunzip Homo_sapiens.GRCh38.cdna.all.release-94_k31.idx.gz```  
- 転写産物の定量  
  - kallistoの出力先ディレクトリを作成する  
  - ```mkdir -p ~/Documents/expression/kallisto```  
  - ```cd ~/Documents/expression/kallisto```  
  - 転写産物の定量（コマンド例）  
  - ```kallisto quant --index=../ref/kallisto.idx --output-dir=SRR******* --bootstrap-samples=100 --threads=2 ../seq/SRR*******_1.fastq.gz ../seq/SRR*******_2.fastq.gz```  
    - --index でインデックスファイルを指定（-i と入力しないと動かない場合があります）  
    - インデックスファイルの名前は必要に応じて変更  
    - --output-dir では出力先のディレクトリ名を指定（あらかじめディレクトリを準備する必要はない）  
    - --bootstrap-samples は転写産物の推定値の信頼性を評価するためのブートストラップサンプリングの回数を指定  
    - --threadsはスレッド数を指定  
    - --pseudobamオプションを付けるとpseudoalignmentの結果をBAMファイルとして保存することができ、別の解析ソフトに読み込ませることが可能になる  
  - 多サンプル処理する場合は下記のようにするとコマンド入力のミスを少なくできる（下記コマンドの「run_ids」は、現在SRAからダウンロードすると「SRR_Acc_List.txt」というファイル名になります。修正しました。また「--index」を「-i」にしないと動かない場合もあります）
    ~~cat ../seq/run_ids | while read sample; do echo processing ${sample}; kallisto quant --index=../ref/kallisto.idx --output-dir=${sample} --bootstrap-samples=100 --threads=4 ../seq/${sample}_1.fastq.gz ../seq/${sample}_2.fastq.gz; done; echo finished~~  
    - ```cat ../seq/SRR_Acc_List.txt | while read sample; do echo processing ${sample}; kallisto quant --index=../ref/kallisto.idx --output-dir=${sample} --bootstrap-samples=100 --threads=4 ../seq/${sample}_1.fastq.gz ../seq/${sample}_2.fastq.gz; done; echo finished```  
    - 最後に finished と表示されれば終了  
  - 全サンプルの出力結果を確認するためには以下のコマンドを実行する  
    - ```find ~/Documents/expression/kallisto -type f```  
## Sleuth
- kallistoの作業と同じく sleuth も ~/Documents/expression/kallisto で作業する  
  - ```cd ~/Documents/expression/kallisto```  
- サンプル情報が記載されたファイルを作成する
  - ```R```  
### 以下R環境下での作業  
- ~~```df <- read.csv("../seq/SraRunTable.txt.csv",stringsAsFactors=F)```~~ ダウンロードファイルの拡張子が .csv 無しになったようです。  
- ```df <- read.csv("../seq/SraRunTable.txt",stringsAsFactors=F)```  
- ~~```df2 <- data.frame(sample=df$Run, group=df$diseasestatus, path=df$Run)```~~ 誤りがありました。  
- ```df2 <- data.frame(sample=df$Run, condition=df$diseasestatus, path=df$Run)```  
- ```write.table(df2, "sample2condition.txt" ,row.names=F, quote=F, sep="\t")```  
- ```q()```  

- Sleuth（Rを用いる）  
  - ```R```  
### 以下R環境下での作業  
- sleuthのインストール  
  - ```source("http://bioconductor.org/biocLite.R")```  
  - ```biocLite("rhdf5")```  
  - （2020/05/21追記 R3.5以上では上記２行のコマンドではインストールできません。代わりに下記を実行してください。）  
    - ```if (!requireNamespace("BiocManager", quietly = TRUE))install.packages("BiocManager")```  
    - ```BiocManager::install("rhdf5")```  
  - ```install.packages("devtools")```  
  - ```devtools::install_github("pachterlab/sleuth")```  
- sleuthパッケージの読み込み  
  - ```library("sleuth")```  
- gridExtraパッケージのインストール・読み込み（20200906追記）  
  - ```install.packages("gridExtra")```
  - ```library(gridExtra)```
- サンプル情報を読み込む（読み込むテキストファイルの名前が誤っていました）  
  - ~~```s2c <- read.table("sample.txt", header=T, stringsAsFactors=F, sep="\t")```~~  
  - ```s2c <- read.table("sample2condition.txt", header=T, stringsAsFactors=F, sep="\t")```  
  - ```s2c$condition <- gsub(" ","_",s2c$condition)```  
- 表示させて内容を確認する  
  - ```s2c```  
- 遺伝子IDと遺伝子名の対応表を読み込む  
  - ```t2g <- read.table("../ref/target2gene.txt", header=T, stringsAsFactors=F)```  
- kallisto の出力ファイルを読み込む  
  - isoform-level でデータを読み込む場合は以下  
    - ```so <- sleuth_prep(s2c, extra_bootstrap_summary=T, target_mapping=t2g)```  
  - gene-levelでデータを読み込む場合は以下  
    - ```so <- sleuth_prep(s2c, extra_bootstrap_summary=T, target_mapping=t2g, aggregation_column='ens_gene', gene_mode=T)```  
- kallisto の結果を眺める（先頭の20行のみ）  
  - ```head(kallisto_table(so), 20)```  
- 遺伝子IDに対応する遺伝子名を付与する  
  - ```kallisto.df <- kallisto_table(so)```  
  - ```kallisto.df$target_id2 <- sub("\\..*","",kallisto.df$target_id)```  
  - ```kallisto.df <- merge(kallisto.df,t2g, by.x="target_id2", by.y="target_id") # 遺伝子レベルで解析する場合は最後をby.y="ens_gene"に変更する```  
- 今回は使わないが、このデータは別の解析などにも活用できるので保存しておく  
  - ```write.table(kallisto.df, "kallisto_res.txt", row.names=F, quote=F)```  
- 尤度比検定（Log-likelihood ratio test; LRT）  
  - ```so <- sleuth_fit(so, ~condition, 'full')```  
  - ```LRT <- sleuth_fit(so, ~1, 'reduced')```  
  - ```LRT <- sleuth_lrt(LRT, 'reduced', 'full')```  
  - ```LRT_table <- sleuth_results(LRT, 'reduced:full', 'lrt', show_all=F)```  
  - 尤度比検定結果を眺める（先頭10行のみ）  
    - ```head(LRT_table, 10)```  
  - 発現量をボックスプロットおよびヒートマップで図示する  
    - ```library(ggplot2)```  
    - ```p <- plot_bootstrap(LRT, "ENST00000503567.5", units="est_counts", color_by="condition")```  
  - 図を表示させる  
    - ```p```  
  - 図を保存する  
    - ```ggplot2::ggsave("ENST00000503567.5.png", p)```  
    - 拡張子を .pdf や .eps にすることでファイル形式を選択できる  
    - width や height で画像サイズも指定できる  
  - 作図に使われている生データは下記で抜き出すことができる  
    - ```data <- as.data.frame(LRT$bs_quants)```  
    - ```head(data)```  
    - 箱ひげ図の棒の上下端が max/min、箱の上下が upper/lower、箱内の横線が midに対応している。このデータを用いてggplot2などで作図できる
  - ヒートマップ（p値の低い20遺伝子で作図する）  
    - 上記のコマンドですでにp値の低い順に並べ替えてあるので、上から順に20個の遺伝子IDを指定する  
    - ```transcripts <- LRT_table$target_id[1:20]```  
    - ヒートマップはgtableオブジェクトのためggsave()は使えず、直接書き出す必要がある  
    - ```pdf('heatmap.pdf') # ここではPDF形式で保存してみる```  
    - ```plot_transcript_heatmap(LRT, transcripts, units="tpm")```  
    - ```dev.off()```  
- Wald検定（WT）  
  - ```WT <- sleuth_wt(so, 'conditionType_1_Diabetes') # conditionに続けて群の名前を記述する。適切な名前でない場合はエラーメッセージとともに適切な名前が示唆されるので、それを用いたコマンドを再実行するとよい```  
  - ```WT_table <- sleuth_results(WT, 'conditionType_1_Diabetes')```  
  - q値の小さい順に並べ替える  
    - ```WT_table <- WT_table[order(WT_table$qval),]```  
  - 結果を保存する  
    - ```write.table(WT_table, "WT_res.sorted.txt", row.names=F, quote=F, sep="\t")```  
  - Volcanoプロットで作図  
    - ```p3 <- plot_volcano(WT, 'conditionType_1_Diabetes', 'wt')```  
    - ```ggsave("volcanoplot.png", p3)```  
    - volcano plot 作図用のデータは WT_table にも含まれているので、ggplot2などを使って自分で作図することができる  

